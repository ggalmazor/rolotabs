name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Build
        run: deno task build

      - name: Package extension
        run: |
          cd extension && zip -r ../rolotabs-${{ github.ref_name }}.zip \
            manifest.json sidepanel.html sidepanel.css dist/ icons/*.png

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: rolotabs-${{ github.ref_name }}.zip
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get access token
        id: token
        run: |
          RESPONSE=$(curl -s -X POST "https://oauth2.googleapis.com/token" \
            -d "client_id=${{ secrets.CWS_CLIENT_ID }}" \
            -d "client_secret=${{ secrets.CWS_CLIENT_SECRET }}" \
            -d "refresh_token=${{ secrets.CWS_REFRESH_TOKEN }}" \
            -d "grant_type=refresh_token")
          TOKEN=$(echo "$RESPONSE" | jq -r '.access_token')
          if [ "$TOKEN" = "null" ] || [ -z "$TOKEN" ]; then
            echo "Failed to get access token: $RESPONSE"
            exit 1
          fi
          echo "::add-mask::$TOKEN"
          echo "access_token=$TOKEN" >> "$GITHUB_OUTPUT"

      - name: Upload to Chrome Web Store
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X PUT "https://www.googleapis.com/upload/chromewebstore/v1.1/items/ilmppkakeeanjkhbiapoknnliimihifa" \
            -H "Authorization: Bearer ${{ steps.token.outputs.access_token }}" \
            -H "x-goog-api-version: 2" \
            -T "rolotabs-${{ github.ref_name }}.zip")
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo "$BODY"
          STATUS=$(echo "$BODY" | jq -r '.uploadState')
          if [ "$STATUS" != "SUCCESS" ]; then
            echo "Upload failed with status: $STATUS"
            exit 1
          fi

      - name: Publish to Chrome Web Store
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "https://www.googleapis.com/chromewebstore/v1.1/items/ilmppkakeeanjkhbiapoknnliimihifa/publish" \
            -H "Authorization: Bearer ${{ steps.token.outputs.access_token }}" \
            -H "x-goog-api-version: 2" \
            -H "Content-Length: 0")
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo "$BODY"
          STATUS=$(echo "$BODY" | jq -r '.status[0]')
          if [ "$STATUS" != "OK" ] && [ "$STATUS" != "PUBLISHED_WITH_FRICTION_WARNING" ]; then
            echo "Publish failed with status: $STATUS"
            exit 1
          fi
